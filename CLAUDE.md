# Руководство по проекту Lotto

## Общая информация о проекте

Lotto - это децентрализованное приложение (dApp) для проведения лотерей на блокчейне Ethereum. Основные компоненты:

1. **Casino** - главный контракт, который управляет лотерейными автоматами
2. **LotteryMachine** - контракт лотерейного автомата, который создает и управляет билетами
3. **Ticket** - контракт билета для участия в лотерее

### Основные функции

- Создание казино с лотерейными автоматами
- Создание лотерейных автоматов внутри казино
- Создание билетов с разными ценами и ограничениями по количеству игроков
- Покупка билетов пользователями
- Автоматическое определение победителя при достижении лимита игроков
- Автоматическая выплата выигрыша победителю

### Техническая архитектура

- **Фронтенд**: React + TypeScript + Vite
- **Смарт-контракты**: Solidity 0.8.9
- **Локальный блокчейн**: Hardhat
- **Взаимодействие с блокчейном**: ethers.js 5.7.0
- **Кошелек**: MetaMask
- **UI-оповещения**: React-Toastify
- **Тестирование**: Playwright для E2E тестов
- **Окружение**: Node.js v22.12.0 (текущая версия)

## Команды сборки и тестирования
- `npm run start` - Запуск Vite и Hardhat одновременно
- `npm run dev` - Запуск сервера разработки Vite на порту 8080 
- `npm run hardhat` - Запуск локального узла блокчейна Hardhat
- `npm run test` - Запуск всех тестов Playwright
- `npm run test:ui` - Запуск UI интерфейса Playwright для тестов
- `npm run screenshot` - Запуск теста для создания скриншотов

## Детальный обзор функциональности

### Метаданные проекта
- Название: ZA-IT Lotto
- Целевая платформа: Web (браузер с поддержкой MetaMask)
- Версия: 0.1.0
- Совместимость: Node.js >= 18.6.0

### Процесс работы приложения
1. Пользователь подключает MetaMask
2. Пользователь создает казино или использует существующее
3. Внутри казино можно создавать лотерейные автоматы
4. Внутри лотерейных автоматов можно создавать билеты с разными параметрами
5. Пользователи покупают билеты через регистрацию (вызов функции register)
6. При достижении лимита игроков автоматически определяется победитель
7. Победителю выплачивается выигрыш, комиссия остается в лотерейном автомате

### Механизм хранения данных
- Адреса контрактов казино сохраняются в localStorage браузера
- Состояние интерфейса управляется через React-контексты
- Данные контрактов загружаются при инициализации компонентов

## Смарт-контракты

### Casino.sol
Основной контракт казино, отвечающий за:
- Создание новых лотерейных автоматов
- Управление комиссией (1%)
- Отслеживание всех созданных автоматов
- Получение баланса и вывод средств владельцем

Основные функции:
- `createMachine()` - создает новый лотерейный автомат
- `getMachines()` - получает список всех созданных автоматов
- `getBalance()` - получает баланс контракта
- `getOwner()` - получает адрес владельца
- `getCommision()` - получает размер комиссии
- `withdrow()` - позволяет владельцу вывести средства

### LotteryMachine.sol
Контракт лотерейного автомата, который:
- Создает различные типы билетов
- Управляет билетами внутри автомата
- Отслеживает баланс и комиссию
- Перенаправляет комиссию в Casino

Основные функции:
- `createTicket(uint _price, uint _limit)` - создает новый билет с указанной ценой и лимитом игроков
- `getTickets()` - получает список всех созданных билетов
- `getBalance()` - получает баланс контракта
- `getOwner()` - получает адрес владельца
- `getCommision()` - получает размер комиссии
- `withdrow()` - позволяет владельцу вывести средства

### Ticket.sol
Контракт билета, который:
- Хранит цену, лимит игроков и комиссию
- Регистрирует игроков
- Автоматически выбирает победителя при достижении лимита
- Выплачивает выигрыш победителю

Основные функции:
- `register()` - позволяет пользователю зарегистрироваться (купить билет)
- `random()` - генерирует случайное число для определения победителя (небезопасная реализация)
- `payout(address _player)` - выплачивает выигрыш победителю
- `getPrice()`, `getLimit()`, `getPlayers()`, `getBalance()`, `getOwner()` - геттеры для получения информации о билете

## Взаимодействие с фронтендом

### React-контексты
- **AccountContext** - управление подключением MetaMask и аккаунтом пользователя
  - Хранит: account, balance
  - Методы: requestAccounts, getBalance
  - События: accountsChanged (MetaMask)

- **CasinoContext** - управление контрактом Casino
  - Хранит: contract, balance, machines, owner
  - Методы: deployCasino, createMachine, getAllData
  - Хранение: LOCAL_STORAGE_CASINO_CONTRACT_ADDRESS

- **LotteryMachineContext** - управление контрактами лотерейных автоматов
  - Хранит: address, contract, balance, tickets, owner
  - Методы: createTicket, getAllData

- **TicketContext** - управление контрактами билетов
  - Хранит: address, contract, balance, price, players, limit, owner
  - Методы: sendRegister, getAllData

### Основные компоненты
- **App** - корневой компонент приложения
- **Auth** - компонент аутентификации (подключение MetaMask)
- **Header** - шапка с логотипом и информацией о кошельке
- **Casino** - отображение казино и всех лотерейных автоматов
- **LotteryMachine** - отображение лотерейного автомата и его билетов
- **Lottery** - отображение всех билетов в лотерейном автомате
- **Ticket** - отображение билета, цены, игроков и т.д.
- **Wallet** - отображение информации о кошельке
- **SvgLogo** - компонент с логотипом

### Утилиты
- **getProvider** - получение Web3Provider Ethereum
- **getSigner** - получение Signer для подписи транзакций
- **getHash** - отображение укороченного адреса с возможностью копирования
- **shortenAddress** - укорачивание адреса для отображения

## Выполненные улучшения (MVP)

### 1. Рефакторинг контрактов
- ✅ Контракт Ticket.sol обновлен для использования стандарта ERC-721 (NFT)
- ✅ Добавлена интеграция с Chainlink VRF для безопасной генерации случайных чисел
- ✅ Реализован запасной механизм генерации псевдослучайных чисел
- ✅ Добавлена функция transfer для передачи билетов между пользователями
- ✅ Улучшено управление комиссиями и событиями
- ✅ Использованы контракты OpenZeppelin для безопасности (Ownable, ERC721Enumerable)
- ✅ Обновлены контракты LotteryMachine.sol и Casino.sol для работы с новым Ticket.sol

### 2. Улучшение фронтенда
- ✅ Создана страница "Мои билеты" для отображения всех билетов пользователя
- ✅ Добавлена функциональность для передачи билетов другим пользователям
- ✅ Улучшен UI/UX (стили, анимации, отзывчивость)
- ✅ Обновлена навигация, добавлены новые маршруты
- ✅ Улучшена обработка ошибок и уведомления пользователя

### 3. Тестирование
- ✅ Настроен Playwright для E2E тестирования
- ✅ Создан тест для автоматического создания скриншотов
- ✅ Добавлено моделирование взаимодействия с MetaMask
- ✅ Настроен скрипт для запуска тестов (`npm run test`, `npm run screenshot`)

### 4. Безопасность
- ✅ Улучшена безопасность смарт-контрактов
- ✅ Добавлены проверки на входные данные
- ✅ Улучшено управление состоянием игры
- ✅ Добавлены события для отслеживания важных действий
- ✅ Использованы безопасные паттерны для перевода ETH

### 5. Улучшения разработки
- ✅ Обновлен файл конфигурации Hardhat
- ✅ Добавлены константы для конфигурации Chainlink VRF
- ✅ Улучшена структура и организация кода
- ✅ Добавлена подробная документация

## План дальнейших улучшений

### 1. Дополнительная функциональность контрактов
- Добавить различные типы лотерей (мгновенные, с отложенным розыгрышем)
- Реализовать механизм "подарочных" билетов
- Добавить метаданные к NFT билетам (изображения, свойства)
- Реализовать маркетплейс для билетов

### 2. Улучшение фронтенда
- Добавить страницу "История выигрышей"
- Создать панель администратора для владельцев казино
- Добавить анимацию розыгрыша и визуализацию случайного выбора
- Добавить мультиязычность

### 3. Тестирование
- Добавить тесты для смарт-контрактов с использованием hardhat
- Расширить покрытие E2E тестов
- Добавить интеграционные тесты

### 4. Безопасность
- Провести аудит безопасности смарт-контрактов
- Внедрить механизм управления обновлениями (Proxy pattern)
- Добавить многоподписную аутентификацию для важных операций

### 5. Документация и маркетинг
- Создать полноценное руководство пользователя
- Добавить видео-руководства
- Разработать стратегию продвижения продукта

## Известные проблемы и предупреждения

### Решенные проблемы
- ✅ Улучшена функция random() в Ticket.sol для использования Chainlink VRF (с резервным механизмом)
- ✅ Билеты реализованы как токены ERC-721 (NFT), поэтому могут отображаться в кошельке
- ✅ Добавлена возможность передачи билетов между пользователями
- ✅ Добавлены базовые E2E тесты с Playwright
- ✅ Улучшена типизация в React-компонентах

### Остающиеся ограничения
- Для полноценной работы Chainlink VRF требуется настройка на реальной сети с токенами LINK
- В тестовом/локальном окружении используется запасной механизм генерации псевдослучайных чисел
- Отсутствуют unit-тесты для смарт-контрактов
- Интерфейс MetaMask в тестах эмулируется, но не используется реальное расширение
- Для отображения NFT в реальном кошельке требуется дополнительная настройка метаданных
- Версионные конфликты: Hardhat предпочитает Node.js ^14.0.0 || ^16.0.0 || ^18.0.0, а установлена v22.12.0
- Зависимости Hardhat требуют установки дополнительных пакетов для корректной работы

### Текущее состояние реализации
1. Улучшены контракты с поддержкой ERC-721 и Chainlink VRF
2. Добавлен механизм передачи билетов между пользователями 
3. Создана страница "Мои билеты" для просмотра коллекции
4. Разработаны тесты Playwright для автоматизации и скриншотов
5. Обновлен интерфейс и стили приложения
6. Добавлена подробная документация в README.md и CLAUDE.md

### Необходимые шаги для запуска
1. Установить Node.js версии 18.x для полной совместимости с Hardhat
2. Установить зависимости: `npm install`
3. Установить Playwright: `npx playwright install` и `npx playwright install-deps`
4. Запустить Hardhat ноду: `npm run hardhat`
5. В отдельном терминале запустить Vite: `npm run dev`
6. Для запуска тестов: `npm run test` или `npm run screenshot`

### Решение проблем с Node.js v22
Если вы используете Node.js v22, могут возникнуть проблемы совместимости с Hardhat. Рекомендуется использовать Node.js v18. Для работы в текущей среде с Node.js v22, необходимы дополнительные шаги:

1. Установить пакеты Hardhat: 
   ```
   npm install @nomiclabs/hardhat-waffle @nomiclabs/hardhat-ethers ethereum-waffle chai @openzeppelin/contracts @chainlink/contracts --save-dev
   ```

2. Изменить hardhat.config.js, добавив опцию:
   ```js
   module.exports = {
     solidity: "0.8.9",
     // ...существующая конфигурация
     mocha: {
       timeout: 40000,
     },
     // Добавить опцию для игнорирования проверки версии Node.js
     ignoreNodeVersion: true
   };
   ```

3. При запуске тестов с Playwright, убедитесь, что Hardhat и Vite уже запущены в отдельных терминалах.

### Список скриншотов
Тест E2E создает следующие скриншоты:
1. `01-initial-page.png` - Начальная страница приложения
2. `02-connected-metamask.png` - После подключения MetaMask
3. `03-casino-deployed.png` - После создания казино
4. `04-machine-created.png` - После создания лотерейной машины
5. `05-ticket-created.png` - После создания билета
6. `06-first-ticket-purchased.png` - После покупки первого билета
7. `07-lottery-completed.png` - После покупки второго билета и завершения лотереи
8. `08-my-tickets-page.png` - Страница "Мои билеты"
9. `09-final-result.png` - Итоговый результат тестирования

## Стиль кода

### TypeScript
- Использовать строгую типизацию в TypeScript
- Следовать псевдонимам путей, определенным в tsconfig.json (@components, @utils и т.д.)
- Целевой стандарт ES2020

### React
- Использовать функциональные компоненты с хуками
- Предпочтительно использовать TypeScript для компонентов React (расширение .tsx)
- Использовать правильный стиль импорта React: `import React from 'react'`

### Solidity
- Использовать версию solidity 0.8.9
- Следовать стандартным практикам безопасности Solidity

### Структура проекта
- React компоненты в `/src/components/`
- Смарт-контракты в `/contracts/`
- Статические ресурсы в `/public/`

### Обработка ошибок
- Использовать try/catch для асинхронных операций
- Правильно обрабатывать ошибки контрактов в коде фронтенда
- Использовать React-Toastify для уведомлений пользователей